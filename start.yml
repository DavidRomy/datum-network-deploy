---
# 启动所有服务


# - hosts: via
#   tags:
#     - via
#   tasks:
#     - name: start via
#       shell: "nohup {{ deploy_dir }}/via/via -cnf {{ deploy_dir }}/via/config/via.yml &"
      
#     - name: wait until the via_port port is up
#       wait_for:
#         host: "{{ ansible_host }}"
#         port: "{{ via_port }}"
#         state: started
#         msg: "the node_exporter port {{ via_port }} is not up"


- hosts: carrier
  tags:
    - carrier
  tasks:
    - name: start carrier
      shell: "nohup {{ deploy_dir }}/carrier/carrier --config-file {{ deploy_dir }}/carrier/config/carrier.yml &"

    - name: wait until the carrier_rpc_port port is up
      wait_for:
        host: "{{ ansible_host }}"
        port: "{{ carrier_rpc_port }}"
        state: started
        msg: "the node_exporter port {{ carrier_rpc_port }} is not up"

# - hosts: admin
#   tags:
#     - admin
#   tasks:
#     - name: start admin
#       shell: "cd {{ deploy_dir }}/admin && nohup java -jar {{ deploy_dir }}/admin/admin.jar --spring.profiles.active=admin &"
    
#     - name: wait until the admin_web_port port is up
#       wait_for:
#         host: "{{ ansible_host }}"
#         port: "{{ admin_web_port }}"
#         state: started
#         msg: "the node_exporter port {{ admin_web_port }} is not up"

# - hosts: data
#   tags:
#     - data
#   tasks:
#     - name: start data
#       shell: "nohup {{ deploy_dir }}/data/start_data_svc.sh {{ deploy_dir }}/data/config/data.yml &"
    
#     - name: wait until the data_port port is up
#       wait_for:
#         host: "{{ ansible_host }}"
#         port: "{{ data_port }}"
#         state: started
#         msg: "the node_exporter port {{ data_port }} is not up"

# - hosts: compute
#   tags:
#     - compute
#   tasks:
#     - name: start compute
#       shell: "nohup {{ deploy_dir }}/compute/start_compute_svc.sh {{ deploy_dir }}/compute/config/compute.yml &"

#     - name: wait until the compute_port port is up
#       wait_for:
#         host: "{{ ansible_host }}"
#         port: "{{ compute_port }}"
#         state: started
#         msg: "the node_exporter port {{ compute_port }} is not up"

# # - name: start consul
# #   hosts: consul
# #   tags:
# #     - consul
# #   tasks:
# #     shell: "nohup {{ deploy_dir }}/compute/start_compute_svc.sh {{ deploy_dir }}/compute/config/compute.yml &"

# - hosts: storage
#   tags:
#     - storage
#   tasks:
#     - name: start storage
#       shell: "nohup java -jar {{ deploy_dir }}/storage/storage.jar --spring.profiles.active={{ deploy_dir }}/storage/config/storage.yml &"

#     - name: wait until the storage_port port is up
#       wait_for:
#         host: "{{ ansible_host }}"
#         port: "{{ storage_port }}"
#         state: started
#         msg: "the node_exporter port {{ storage_port }} is not up"

# - hosts: scan
#   tags:
#     - scan
#   tasks:
#     - name: start scan
#       shell: "nohup java -jar {{ deploy_dir }}/scan/scan.jar --spring.profiles.active={{ deploy_dir }}/scan/config/scan.yml &"

#     - name: wait until the scan_web_port port is up
#       wait_for:
#         host: "{{ ansible_host }}"
#         port: "{{ scan_web_port }}"
#         state: started
#         msg: "the node_exporter port {{ scan_web_port }} is not up"